#include "melody.h"
#include <stdint.h>
extern void play_note(float freq,uint16_t duration,double vol);

// Melody array
//const melody_s mary_lamb_melody[MARY_LAMB_LENGTH] = {
//    {329.63, 1.0}, {293.66, 1.0}, {261.63, 1.0}, {293.66, 1.0}, {329.63, 1.0}, {329.63, 1.0}, {329.63, 1.2},
//    {293.66, 1.0}, {293.66, 1.0}, {293.66, 1.2}, {329.63, 1.0}, {392.00, 1.0}, {392.00, 1.2},
//    {329.63, 1.0}, {293.66, 1.0}, {261.63, 1.0}, {293.66, 1.0}, {329.63, 1.0}, {329.63, 1.0}, {329.63, 1.0},
//    {293.66, 1.0}, {293.66, 1.0}, {329.63, 1.0}, {293.66, 1.0}, {261.63, 1.2}
//};

//const double C4 = 261.63;
//const double D4 = 293.66;
//const double E4 = 329.63;
//const double G4 = 392.00;
//
//// Define note durations based on a tempo of 120 BPM.
//// At 120 BPM, a quarter note is 0.5 seconds.
//const double QUARTER_NOTE = 0.5;
//const double HALF_NOTE = 1.0;

// An array of Note structs representing the melody.
// This is the sequence of notes for "Mary Had a Little Lamb."
//const melody_s mary_lamb_melody[] = {
//    // "Mary had a lit-tle lamb"
//    {E4, QUARTER_NOTE}, {D4, QUARTER_NOTE}, {C4, QUARTER_NOTE}, {D4, QUARTER_NOTE},
//    {E4, QUARTER_NOTE}, {E4, QUARTER_NOTE}, {E4, HALF_NOTE},
//
//    // "lit-tle lamb, lit-tle lamb"
//    {D4, QUARTER_NOTE}, {D4, QUARTER_NOTE}, {D4, HALF_NOTE},
//    {E4, QUARTER_NOTE}, {G4, QUARTER_NOTE}, {G4, HALF_NOTE},
//
//    // "Ma-ry had a lit-tle lamb"
//    {E4, QUARTER_NOTE}, {D4, QUARTER_NOTE}, {C4, QUARTER_NOTE}, {D4, QUARTER_NOTE},
//    {E4, QUARTER_NOTE}, {E4, QUARTER_NOTE}, {E4, HALF_NOTE},
//
//    // "its fleece was white as snow"
//    {E4, QUARTER_NOTE}, {D4, QUARTER_NOTE}, {D4, QUARTER_NOTE}, {E4, QUARTER_NOTE},
//    {D4, QUARTER_NOTE}, {C4, HALF_NOTE}
//};

// Enum to define how a note is played.
enum Articulation {
    NORMAL,  // Standard note
    LEGATO,  // Smoothly connected to the next note
    STACCATO // Short and detached
};

// Enum to define the dynamics (volume) of a note.
enum Dynamics {
    PIANO,     // Soft
    MEZZO_FORTE, // Medium loud
    FORTE      // Loud
};

// A structure to hold all the musical parameters for a single note.
struct melody_s {
    double frequency;
    double duration;
    double volume; // Calculated from Dynamics
    Articulation articulation;
};

// Define note frequencies based on A4 = 440 Hz.
const double C4 = 261.63;
const double D4 = 293.66;
const double E4 = 329.63;
const double G4 = 392.00;

// Define base note durations for a tempo of 120 BPM.
const double QUARTER_NOTE = 0.5;
const double HALF_NOTE = 1.0;

// Define base volumes for dynamics.
const double VOLUME_PIANO = 0.6;
const double VOLUME_MEZZO_FORTE = 0.8;
const double VOLUME_FORTE = 1.0;

// An array of Note structs representing the expressive melody.
const Note mary_lamb_melody[] = {
    // "Ma-ry had a lit-tle lamb"
    {E4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {C4, QUARTER_NOTE, VOLUME_PIANO, NORMAL}, // Softer "had"
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {E4, QUARTER_NOTE, VOLUME_FORTE, LEGATO},   // Louder, connected
    {E4, QUARTER_NOTE, VOLUME_FORTE, LEGATO},   // Louder, connected
    {E4, HALF_NOTE, VOLUME_FORTE, NORMAL},

    // "lit-tle lamb, lit-tle lamb"
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, STACCATO}, // Detached
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, STACCATO}, // Detached
    {D4, HALF_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {E4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {G4, QUARTER_NOTE, VOLUME_FORTE, LEGATO},
    {G4, HALF_NOTE, VOLUME_FORTE, NORMAL},

    // "Ma-ry had a lit-tle lamb"
    {E4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {C4, QUARTER_NOTE, VOLUME_PIANO, NORMAL}, // Softer "had"
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {E4, QUARTER_NOTE, VOLUME_FORTE, LEGATO},
    {E4, QUARTER_NOTE, VOLUME_FORTE, LEGATO},
    {E4, HALF_NOTE, VOLUME_FORTE, NORMAL},

    // "its fleece was white as snow"
    {E4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {D4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {E4, QUARTER_NOTE, VOLUME_MEZZO_FORTE, NORMAL},
    {D4, QUARTER_NOTE, VOLUME_PIANO, STACCATO},
    {C4, HALF_NOTE, VOLUME_PIANO, NORMAL} // Final note is soft
};

void play_melody(const melody_s* mel,int len)
{
	for(int i=0;i<len;i++)
	{
		play_note( mel[i].note_freq , mel[i].seconds * 1000 , mel[i].volume );
	}
}
